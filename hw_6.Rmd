---
title: "hw_6"
author: "Qetsiyah Wang"
date: "12/9/2020"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      fig.height = 6, fig.width = 8)

library(tidyverse)
library(dplyr)
library(modelr)
library(purrr)
library(patchwork)
```

# Problem.1 Homicide Dataset
### Tidy dataset
```{r}
homicide = read_csv("homicide-data.csv") %>%
  mutate(
    city_state = paste(city,",", state),
    resolved = as.numeric(disposition == "Closed by arrest")
  ) %>%
  filter(city !=  "Dallas" & city != "Phoenix" & city != "Kansas city" & city != "Tulsa") %>%
  filter(victim_race == "White" | victim_race == "Black") %>%
  filter(!is.na(victim_age))
```

### Logistic regression for Baltimore
```{r}




```




# Problem 2 Birthweight
### Tidy data and Check missing values
```{r}
birthweight = read_csv("birthweight.csv") %>%
  janitor::clean_names() %>%
  mutate(
    babysex = as.factor(babysex), 
    frace = as.factor(frace), 
    malform = as.factor(malform), 
    mrace = as.factor(mrace)
)

birthweight = birthweight[!apply(is.na(birthweight[1:length(birthweight)]), 1, any),]
```

   After checking all variables within the birthweight dataset, variables that are appropriate for turning into factor are all changed into the factor type. And the dataset does not contain any missing values.

### Build optimal model
```{r}
step(lm(data = birthweight, bwt ~.), direction = "both")

optimal_mod = birthweight %>%
  select(-frace, -malform, -menarche, - momage, - pnumlbw, - pnumsga, -wtgain) %>%
  lm(bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + mheight + mrace + 
       parity + ppwt + smoken, data = .)

birthweight %>%
  select(-frace, -malform, -menarche, - momage, - pnumlbw, - pnumsga, -wtgain) %>%
  modelr::add_predictions(optimal_mod) %>%
  modelr::add_residuals(optimal_mod) %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(
    title = "Model Residuals Against Fitted Values",
    x = "Fitted Values",
    y = "Residuals"
  )

```

### Cross validate three models
```{r}

blength_gaweeks = birthweight %>%
  select(bwt, blength, gaweeks) %>%
  lm(bwt ~ blength, gaweeks, data = .)

head_len_sex = birthweight %>%
  select(bwt, bhead, blength, babysex) %>%
  lm(bwt ~ bhead +blength + babysex + bhead*blength*babysex, data = .)

cv = crossv_mc(birthweight, 100) %>%
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  )

cv = cv %>%
  mutate(
    optimal_model = map(train, ~ optimal_mod),
    blength_gaweeks_model = map(train, ~ blength_gaweeks),
    head_len_sex_model = map(train, ~ head_len_sex)
  ) %>%
  mutate(
    rmse_opt_mod = map2_dbl(optimal_model, test, ~ rmse(model = .x, data = .y)),
    rmse_len_ga_mod = map2_dbl(blength_gaweeks_model, test, ~ rmse(model = .x, data = .y)),
    rmse_head_len_sex_mod = map2_dbl(head_len_sex_model, test, ~ rmse(model = .x, data = .y))
  )

cv %>%
  select(starts_with("rmse")) %>%
  pivot_longer(
    everything(),
    names_to = "model",
    values_to = "rmse",
    names_prefix = "rmse_"
  ) %>%
  mutate(
    model = fct_inorder(model)
  ) %>%
  ggplot(aes(x = model, y = rmse)) +
  geom_violin()
```


# Problem 3. Central Park Weather
```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```

### Generate values of r-square and log-estimate
```{r}

weather_strap = weather_df %>%
  modelr::bootstrap(n = 5000) %>%
  mutate(
    models = map(strap, ~ lm(tmax ~ tmin, data = .)),
    r = map(models, broom::glance),
    conf_int = map(models, broom::tidy)
  ) %>%
  unnest(r, conf_int) %>%
  select(r.squared, estimate, term) %>%
  pivot_wider(
    names_from = term,
    values_from = estimate
  ) %>%
  janitor::clean_names() %>%
  mutate(
    log_estimate = log(intercept * tmin)
  )

r_plot = weather_strap %>%
  ggplot(aes(x = r_squared)) +
  geom_density(color = "blue") +
  labs(
    title = "Distribution of R-squared Values",
    x = "R-squared Values",
    y = "Density")
  

estimate_plot = weather_strap %>%
  ggplot(aes(x = log_estimate))  +
  geom_density(color = "red") +
  labs(
    title = "Distribution of R-squared Values",
    x = "Log of (intercept*coefficient)",
    y = "Density"
  )

r_plot + estimate_plot

```

### Generate confidence interval
```{r}

conf_int = weather_strap %>%
  pivot_longer(
    intercept : tmin,
    names_to = "term",
    values_to = "estimate"
  ) %>%
  select(-estimate) %>%
  group_by(term) %>%
  summarize(
    lwrci_r = quantile(r_squared, 0.025),
    uprci_r = quantile(r_squared, 0.975),
    lwrci_est = quantile(log_estimate, 0.025),
    uprci_est = quantile(log_estimate, 0.975)
  )

knitr::kable(conf_int)

```


















